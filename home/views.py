from hashlib import new
from os import path
from django.shortcuts import redirect, render
from django.views import View
from django.http import HttpResponse
# Create your views here.
from .forms import FileFieldForm
from .models import MalwareFile
from .utils import predict_malware_file
from MalwareDetection.settings import BASE_DIR
from datetime import datetime
import os

class HomeView(View):
    def __init__(self) -> None:
        self.template = 'home/index.html'

#-------------------- METHOD VIEW --------------------------

    def get(self, request):
        form = FileFieldForm()
        context = {
            'form': form
        }       
        return render(request, template_name= self.template, context=context)


    
    def post(self, request):
        form = FileFieldForm(request.POST, request.FILES)
        print("form:", form.__dict__.keys())
        if form.is_valid():
            now = datetime.now()
            dt_string = now.strftime("%d/%m/%Y_%H:%M:%S")
            title = form.get_file_name()[:-4] + dt_string + '.exe'
            file_field = form.cleaned_data['file_field']            
            MalwareFile.objects.create(title=title, file_field=file_field)

            latest_malware = MalwareFile.objects.latest('id')
            malware_file_name = os.path.join(BASE_DIR , latest_malware.file_field.name)
            print("file was choosen: ",malware_file_name)
            result_dict = predict_malware_file(malware_file_name)
            print(result_dict)
            return redirect('home-view')
        else:
            print(form.errors)
        context = {
            'form': form
        }
        return render(request, template_name=self.template, context=context)
            
        